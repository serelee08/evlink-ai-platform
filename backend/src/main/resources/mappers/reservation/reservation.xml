<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.evlink.domain.reservation.dao.ReservationDao">

	<!-- 예약 시간 중복 확인 -->
	<select id="checkReservationTime" parameterType="reservation" resultType="int">
		SELECT
		COUNT(*)
		FROM
		tb_reservation
		WHERE
		charger_id = #{chargerId}
		AND res_date = #{resDate}
		AND
        (
            -- Case 1: 새로운 예약의 시작 시간이 기존 예약 시간 범위 안에 있는 경우
            (res_start_time &lt;= #{resStartTime} AND res_end_time &gt; #{resStartTime})
            OR
            -- Case 2: 새로운 예약의 종료 시간이 기존 예약 시간 범위 안에 있는 경우
            (res_start_time &lt; #{resEndTime} AND res_end_time &gt;= #{resEndTime})
            OR
            -- Case 3: 기존 예약 시간이 새로운 예약 시간을 완전히 포함하는 경우
            (res_start_time &gt;= #{resStartTime} AND res_end_time &lt;= #{resEndTime})
        )
    	AND
        res_status = 'R'
	</select>

	<!-- 예약 -->
	<insert id="reservation" parameterType="reservation" useGeneratedKeys="true"
		keyProperty="resId">
		INSERT INTO tb_reservation (
		charger_id, user_id, res_nm, res_tel, res_email,
		res_date, res_start_time, res_end_time, pay_total_hour, res_status,
		use_status
		) VALUES (
		#{chargerId}, #{userId}, #{resNm}, #{resTel}, #{resEmail},
		#{resDate}, #{resStartTime}, #{resEndTime}, #{payTotalHour}, 'R', 'N'
		)
	</insert>
	
	<!-- 예약 취소로 상태업데이트 -->
	<update id="reservationCancel" parameterType="long">
		UPDATE tb_reservation
		SET res_status = 'C'
		WHERE res_id = #{resId}
	</update>
	
	<!-- 예약 취소 상태인지 확인하기위함 -->
	<select id="getResStatus" parameterType="long" resultType="String">
        SELECT res_status
        FROM tb_reservation
        WHERE res_id = #{resId}
    </select>
    
	<!-- 예약리스트 조회 -->
    <select id="reservationList" parameterType="map" resultType="map">
        SELECT * 
          FROM (SELECT tr.res_id, tr.charger_id, tr.user_id, tr.res_nm, tr.res_tel, tr.res_email, tr.res_date, tr.res_start_time, tr.res_end_time, tr.pay_total_hour, tr.res_status, tr.use_status, tr.reg_dt,
                       (select tuc.car_model from tb_user_car tuc where tr.user_id = tuc.user_id) as car_model,
                       (select tpc.addr||' '||tpc.addr_detail from tb_private_charger tpc where tr.charger_id = tpc.charger_id) as chager_addr,
                       ROW_NUMBER() OVER(ORDER BY reg_dt DESC) AS ROW_NUM
                  FROM tb_reservation tr
                <where>
                     <choose>
                        <when test="viewType == 'provider'">
                            tr.charger_id = (SELECT charger_id
                                                  FROM tb_private_charger
                                                 WHERE user_id = #{user_id})
                            <if test="searchType != null and searchValue != null">
                                <choose>
                                     <when test="searchType == 1">
                                        AND tr.res_nm LIKE '%'||#{searchValue}||'%'
                                     </when>
                                     <when test="searchType == 2">
                                        AND car_model LIKE '%'||#{searchValue}||'%'
                                     </when>
                                </choose>
                            </if>
                        </when>
                        <otherwise>
                            tr.user_id = #{user_id}
                            <if test="searchType != null and searchValue != null">
                                <choose>
                                     <when test="searchType == 1">
                                        AND tr.chager_addr LIKE '%'||#{searchValue}||'%'
                                     </when>
                                </choose>
                            </if>
                        </otherwise>
                     </choose>
                </where>
               ) R
        WHERE 1=1
        AND R.ROW_NUM BETWEEN #{begin} AND #{end}
    </select>
    
    <!-- 예약리스트 총 건수 조회 -->
    <select id="totalCount" parameterType="map" resultType="int">
        SELECT COUNT(*) AS TOTALCOUNT
        FROM tb_reservation
        <where>
             <choose>
                <when test="viewType == 'provider'">
                    charger_id = (SELECT charger_id
                                          FROM tb_private_charger
                                         WHERE user_id = #{user_id})
                </when>
                <otherwise>
                    user_id = #{user_id}
                </otherwise>
             </choose>
        </where>
    </select>
	<!-- 프론트 예약가능 시간 조회 -->
	<select id="getReservedTimes" parameterType="map" resultType="map">
		SELECT
		res_start_time,
		res_end_time
		FROM
		tb_reservation
		WHERE
		charger_id = #{chargerId}
		AND res_date = #{date}
		AND res_status = 'R'
	</select>
    
</mapper>