<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.evlink.domain.mypage.dao.CarDao">
    <!-- 차량등록여부 확인 -->
    <select id="checkCarDuplicate" parameterType="int" resultType="int">
        SELECT COUNT(*)
          FROM tb_user_car
         WHERE user_id = #{user_id}
    </select>
    
    <!-- 차량정보 조회 -->
    <select id="getCar" parameterType="int" resultType="mpcar">
        SELECT car_id, user_id, car_plate, car_mf, car_model, car_year, car_socket, reg_dt, upd_dt,
               (SELECT user_tp FROM tb_user WHERE user_id = #{user_id}) as user_tp
          FROM tb_user_car
         WHERE user_id = #{user_id} 
    </select>
    
    <!-- 차량등록 -->
    <update id="addCar" parameterType="mpcar">
        INSERT INTO tb_user_car (user_id, car_plate, car_mf, car_model, car_year, car_socket, reg_dt)
        VALUES(#{user_id}, #{car_plate}, #{car_mf}, #{car_model}, #{car_year}, #{car_socket}, sysdate())
    </update>
    
    <!-- 차량정보 수정 -->
    <update id="updateCar" parameterType="mpcar">
        UPDATE tb_user_car
        <set>
            <if test="car_plate != null">car_plate = #{car_plate},</if>
            <if test="car_mf != null">car_mf = #{car_mf},</if>
            <if test="car_model != null">car_model = #{car_model},</if>
            <if test="car_year != null">car_year = #{car_year},</if>
            <if test="car_socket != null">car_socket = #{car_socket},</if>
            upd_dt = sysdate()
        </set>
         WHERE car_id = #{car_id}
    </update>
    
    <!-- 차량정보 삭제 -->
    <delete id="deleteCar" parameterType="int">
        DELETE FROM tb_user_car WHERE car_id = #{car_id}
    </delete>
    
    <select id="callUserTpUpdate" statementType="CALLABLE" parameterType="mpcar">
        {call UPDATE_USER_TP(#{user_id, mode=IN, jdbcType=BIGINT})}
    </select>
</mapper>